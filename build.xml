<?xml version="1.0"?>

<!-- This is the main build file for the carddav classes and server.

     Authors: Mike Douglass   douglm  rpi edu
-->

<project name="carddav" default="deploy">
  <taskdef resource="net/sf/antcontrib/antcontrib.properties" />

  <property environment="env"/>
  <!-- These may already be set from calling dir -->
  <dirname property="org.bedework.project.carddav" file="${ant.file}"/>
  <dirname property="project.home" file="${ant.file}"/>

  <property file="${project.home}/build.properties" />

  <property name="project.name" value="${org.bedework.package.name}"/>
  <property name="project.version" value="${org.bedework.carddav.version}"/>

  <property name="dist.home" location="${project.home}/dist"/>
  <property name="lib.dir" location="${project.home}/lib"/>

  <property name="build.dir" location="${project.home}/build"/>
  <property name="buildjar" location="${build.dir}/buildTools/buildjar.xml"/>
  <property name="buildwar" location="${build.dir}/buildwar.xml"/>
  <property name="buildsh" location="${build.dir}/buildsh.xml"/>

  <property name="resources.dir" location="${project.home}/resources"/>

  <property name="org.bedework.temp.dir"
            location="${dist.home}/temp" />
  
  <delete dir="${org.bedework.temp.dir}" />
  <mkdir dir="${org.bedework.temp.dir}" />

  <property name="org.bedework.libcache.dir"
            location="${project.home}/libcache"/>

  <import file="${build.dir}/buildTools/getJar.xml"/>
  <import file="${build.dir}/loadDeployConfig.xml"/>

	<!--
  <property name="org.bedework.deployutil.jar"
            location="${build.dir}/${org.bedework.deployutil.jar.name}-${project.version}.jar" />
            -->
  <property name="org.bedework.deployutil.jar"
            location="${build.dir}/bw-deployutil-3.6.jar" />

  <!-- =================================================================
       init:
       ================================================================= -->

  <target name="init">
    <property name="org.bedework.project.bedework"
  	          location="${project.home}/../bedework" />

  	<loadDeployConfig />

    <property name="org.bedework.temp.wars.home"
              location="${dist.home}/temp/wars" />
  	
    <if>
      <not>
        <isset property="org.bedework.global.context.roots" />
      </not>
      <then>
        <tempfile property="org.bedework.global.context.roots"
                  destdir="${org.bedework.temp.dir}"
                  prefix="context-roots" suffix=".properties" />
      </then>
    </if>

    <echo message="*** Options file: ${org.bedework.carddav.options}" />

    <property name="org.bedework.carddav.server.base"
              location="${project.home}/server" />

    <property name="org.bedework.carddav.dumpres.base"
              location="${project.home}/dumpres" />

    <property name="org.bedework.carddav.tools.base"
              location="${project.home}/tools" />

    <mkdir dir="${dist.home}" />

    <property name="test.data.dir"
              location="${dist.home}/test-data" />

    <property name="edu.rpi.cmt.empty.dir"
              location="${dist.home}/empty-dir" />
    <mkdir dir="${edu.rpi.cmt.empty.dir}" />

    <fileset id="empty.fileset" dir="${edu.rpi.cmt.empty.dir}"
             excludes="*" />

    <!-- default to empty -->
    <fileset id="buildjar.resource.files" refid="empty.fileset" />
    <fileset id="buildjar.generated.java.sources" refid="empty.fileset" />

    <property name="server.jar"
              location="${dist.home}/${edu.rpi.cmt.carddav.server.jar}-${project.version}.jar" />

    <property name="dumpres.jar"
              location="${dist.home}/${edu.rpi.cmt.carddav.dumpres.jar}-${project.version}.jar" />

    <property name="tools.jar"
              location="${dist.home}/${edu.rpi.cmt.carddav.tools.jar}-${project.version}.jar" />
  </target>
	
  <target name="build-init" depends="init">
    <delete dir="${lib.dir}" />
    <mkdir dir="${lib.dir}" />

    <property name="org.bedework.getjar.property.prefix"
              value="org.bedework.appjar" />

    <getJar name="commons-codec" version="1.3" />
    <getJar name="commons-httpclient" version="3.0" />
    <getJar name="gdata-calendar" version="1.0" />
    <getJar name="gdata-client" version="1.0" />
    <getJar name="ejb3-persistence" version="3.4.0.GA" />
    <getJar name="hibernate" version="3.3.1.ga" />
    <getJar name="hibernate-annotations" version="3.4.0.GA" />
    <getJar name="ical4j" version="1.0-rc3-SNAPSHOT" />
    <getJar name="ical4j-vcard" version="0.9.3-SNAPSHOT" />
    <getJar name="log4j" version="1.2.8" />
    <getJar name="servletapi" version="2.4" />

    <getJar name="rpiaccess" version="${org.bedework.access.version}" project="access"
            projecthome="${project.home}/../bedework/projects/access" />

    <getJar name="rpiutil" version="${org.bedework.rpiutil.version}" project="rpiutil"
            projecthome="${project.home}/../bedework/projects/rpiutil" />
    
    <getJar name="bw-davio" version="${org.bedework.davutil.version}" project="davutil" 
            projecthome="${project.home}/../bedework/projects/davutil" />

    <getJar name="bw-webdavserver" version="${org.bedework.webdav.version}" project="webdav"
            projecthome="${project.home}/../bedework/projects/webdav" />

    <!-- ==================== Compilation Classpath ==================== -->

    <path id="compile.classpath">
      <fileset dir="${lib.dir}">
         <include name="**/*.jar"/>
      </fileset>
      <fileset dir="${dist.home}">
         <include name="*.jar"/>
      </fileset>
    </path>
  </target>
    
	<target name="deploy-init" depends="init">
    <!-- ========= Stuff in main bedework deployment build file =========   -->
    <!-- Where we put ear stuff -->
    <if>
      <isset property="org.bedework.global.build.ear" />
      <then>
        <property name="app.ear.file.name"
                  value="${org.bedework.global.ear.name}-card.ear" />

        <property name="dumpres.app.zip.name"
                  value="${org.bedework.global.ear.name}-carddumpres" />

        <property name="tools.app.zip.name"
                  value="${org.bedework.global.ear.name}-cardtools" />

        <if>
          <equals arg1="${org.bedework.global.ear.zipped}"
                  arg2="yes" />
          <then>
            <property name="org.bedework.ear.dir"
                      location="${dist.home}/${org.bedework.global.ear.name}-card" />
            <property name="org.bedework.ear.file"
                      location="${dist.home}/${org.bedework.global.ear.name}-card.ear" />
          </then>
          <else>
            <property name="org.bedework.ear.dir"
                      location="${dist.home}/${org.bedework.global.ear.name}-card.ear" />
          </else>
        </if>

        <property name="org.bedework.ear.templib"
                  location="${org.bedework.temp.dir}/earlib" />

        <property name="org.bedework.ear.properties.dir"
                  location="${org.bedework.temp.dir}/ear-properties" />

        <property name="org.bedework.ear.properties.jar"
                  location="${org.bedework.ear.dir}/bw-ear-properties.jar"/>

        <delete dir="${org.bedework.ear.dir}" />
        <mkdir dir="${org.bedework.ear.dir}" />

        <delete dir="${org.bedework.ear.templib}" />
        <mkdir dir="${org.bedework.ear.templib}" />

        <delete dir="${org.bedework.ear.properties.dir}" />
        <mkdir dir="${org.bedework.ear.properties.dir}" />
      </then>
    </if>
    
	  <property name="org.bedework.temp.shellscr.home"
	            location="${org.bedework.temp.dir}/shellscr" />

    <property name="org.bedework.temp.extrajars.dir"
              location="${org.bedework.temp.dir}/extrajars" />

    <!-- Preserve extra jars for ear builds -->
    <property name="org.bedework.temp.ear.extrajars.dir"
              location="${org.bedework.temp.dir}/earextrajars" />
    
    <property name="org.bedework.global.context.roots"
              location="${org.bedework.temp.dir}/context-roots.properties" />

    <!-- ===== End of stuff in main bedework deployment build file ======   -->
		
    <!-- Clean up before we start -->
    <delete dir="${org.bedework.temp.wars.home}" />
    <mkdir dir="${org.bedework.temp.wars.home}" />
  </target>

  <!-- =================================================================
       Clean out all library files from other projects and all generated
       files in preparation for a complete rebuild.

       Needed because switching versions leaves a load of old bedework
       generated stuff in the libraries.
       ================================================================= -->
  <target name="deep-clean" depends="clean">
    <delete dir="${lib.dir}" />
  </target>

  <!-- =================================================================
       Clean all generated files
       ================================================================= -->
  <target name="clean">
    <delete dir="${dist.home}" />
  </target>

  <!-- =================================================================
       Clean up after a build.
       ================================================================= -->
  <target name="cleanup">
    <delete dir="${edu.rpi.cmt.empty.dir}" />
  </target>

  <!-- ========================== Base build Targets ===================
       Here we have one target building the classes and interfaces that make
       up the access control suite.
       ================================================================= -->

  <target name="clean-build" depends="clean,build"
          description="Clean and compile carddav classes"/>

  <target name="clean-build-all" depends="clean,build-all"
          description="Clean and compile carddav classes"/>

  <target name="build" depends="build-source,cleanup"
          description="Compile carddav classes"/>

  <!-- ===================== build.all Target ===============================
     This target builds jar files ready for the deploy target.
     =================================================================== -->

  <target name="build-all" depends="build-source,cleanup"
          description="Compile carddav classes"/>

  <target name="build-source" 
  	      depends="build-init,bld.auth.server,bld.unauth.server,bld.dumpres,bld.tools" />

  <!-- ===================== deploy Target ===============================
     Deploy if an application server is defined.
     =================================================================== -->

  <target name="deploy-addrbook" depends="init"
          description="Deploy address book client">
  	<delete dir="${org.bedework.appserver.dir}/${org.bedework.server.resource.root.dir}/bwAddrbookClient" />
  	
  	<copy todir="${org.bedework.appserver.dir}/${org.bedework.server.resource.root.dir}/bwAddrbookClient" >
  		<fileset dir="clients/javascript/bwAddrbookClient"/>
    </copy>
	</target>
	
  <target name="deploy" depends="deploy-init,build-all,deploy-addrbook"
  	      description="Deploy carddav">
    <ant antfile="deploy.xml" target="deployFiles" inheritRefs="true" />
  	<!--
    <if>
      <isset property="org.bedework.appserver.deploy.dir"/>
      <then>
        <delete dir="${org.bedework.appserver.deploy.dir}/${org.bedework.app.usercarddav.war.name}" />
        <delete dir="${org.bedework.appserver.deploy.dir}/${org.bedework.app.pubcarddav.war.name}" />

        <copy todir="${org.bedework.appserver.deploy.dir}">
          <fileset dir="${dist.home}">
        	  <include name="*.war" />
         </fileset>
        </copy>
      </then>
      <else>
        <echo message="********* No deploy directory defined" />
      </else>
    </if>
    -->
    <getJar lib="${org.bedework.temp.extrajars.dir}"
            libcache="${org.bedework.libcache.dir}"
            name="bw-carddumpres" version="${org.bedework.carddav.version}"
            projecthome="${project.home}" />

    <getJar lib="${org.bedework.temp.extrajars.dir}"
            libcache="${org.bedework.libcache.dir}"
            name="bw-cardtools" version="${org.bedework.carddav.version}"
            projecthome="${project.home}" />

    <ant antfile="deployService.xml" target="deploy" inheritRefs="true" >
    	<property name="propval.app.zip.name"
    	          value="${dumpres.app.zip.name}" />
      <property name="app.service.base" 
                location="${org.bedework.carddav.dumpres.base}" />
    	<property name="app.global.properties.dir" 
                location="${resources.dir}" />
   </ant>

    <getJar lib="${org.bedework.temp.extrajars.dir}"
            libcache="${org.bedework.libcache.dir}"
            name="bw-davio" version="${org.bedework.davutil.version}"
            projecthome="${project.home}/../bedework/projects/davutil" />
    
    <getJar lib="${org.bedework.temp.extrajars.dir}"
            libcache="${org.bedework.libcache.dir}"
            name="log4j" version="1.2.8"/>

    <ant antfile="${buildsh}" target="build" inheritRefs="true" >
      <property name="propval.app.zip.name"
                value="${tools.app.zip.name}" />
      <property name="app.service.base" 
                location="${org.bedework.carddav.tools.base}" />
      <property name="app.global.properties.dir" 
                location="${org.bedework.carddav.tools.base}/resources" />
      <property name="org.bedework.deploy.name" 
                value="tools" />
   </ant>
  	
    <ant antfile="deployTermination.xml" target="deployTerminate" inheritRefs="true" />
  </target>

<!-- ==================== Javadoc Target ===============================
     The "javadoc" target creates Javadoc API documentation for the Java
     classes included in your application.  Normally, this is only required
     when preparing a distribution release, but is available as a separate
     target in case the developer wants to create Javadocs independently.
     =================================================================== -->

  <target name="javadoc" depends="init"
          description="Create Javadoc API documentation">
    <property name="destdir" location="${dist.home}/docs/api"/>
    <mkdir dir="${destdir}"/>

    <javadoc sourcepath="${org.bedework.caldav.server.base}/src:"
           classpathref="compile.classpath"
                destdir="${destdir}"
           packagenames="org.bedework.*,
                         edu.rpi.*"
                 access="public"
                 author="true"
                version="true"
          breakiterator="yes"
            windowtitle="${project.name} ${project.version} API Documentation">
      <doctitle><![CDATA[${project.name} ${project.version}<br/>API Documentation]]></doctitle>
      <header><![CDATA[${project.name} ${project.version}<br/>API Documentation]]></header>
      <link href="../../access/api" />
      <link href="../../calendarapi/api" />
      <link href="../../davutil/api" />
      <link href="../../rpiutil/api" />
      <link href="../../webdav/api" />
      <link href="${env.JAVA_HOME}/docs/api" />
    </javadoc>
  </target>

  <!-- ===================== internal build targets ====================
       ================================================================= -->

  <target name="bld.auth.server">
    <ant antfile="${org.bedework.carddav.server.base}/build.xml" inheritrefs="true"
         target="build" />

    <!-- ===============================================================
         Build the authenticated war
         =============================================================== -->

    <property name="app.sou.dir"
              location="${org.bedework.carddav.server.base}" />

    <ant antfile="${buildwar}" inheritRefs="true" target="build" >
      <property name="propval.app.context.root"
                value="${org.bedework.app.usercarddav.war.name}" />
      <property name="propval.app.war.name"
                value="${org.bedework.app.usercarddav.war.name}" />
      <property name="propval.app.web.xml"
                location="${app.sou.dir}/war/WEB-INF/userweb.xml" />

      <property name="org.bedework.deploy.name"
                value="usercarddav" />
    </ant>
  </target>

  <target name="bld.unauth.server">
    <ant antfile="${org.bedework.carddav.server.base}/build.xml" inheritrefs="true"
         target="build" />

    <!-- ===============================================================
         Build the unauthenticated war
         =============================================================== -->

    <property name="app.sou.dir"
              location="${org.bedework.carddav.server.base}" />

    <ant antfile="${buildwar}" inheritRefs="true" target="build" >
      <property name="propval.app.context.root"
                value="${org.bedework.app.pubcarddav.war.name}" />
      <property name="propval.app.war.name"
                value="${org.bedework.app.pubcarddav.war.name}" />
      <property name="propval.app.web.xml"
                location="${app.sou.dir}/war/WEB-INF/publicweb.xml" />

      <property name="org.bedework.deploy.name"
                value="pubcarddav" />
    </ant>
  </target>

  <target name="bld.dumpres">
    <ant antfile="${org.bedework.carddav.dumpres.base}/build.xml" inheritrefs="true"
         target="build" />
  </target>

  <target name="bld.tools">
    <ant antfile="${org.bedework.carddav.tools.base}/build.xml" inheritrefs="true"
         target="build" />
  </target>
</project>
