<?xml version="1.0"?>

<!-- Run hsqldb for the bedework Calendar quickstart.

     This is imported by the quickstart build.xml ensuring all changes to this file
     appear in the repository.

     Authors: Mike Douglass   douglm - rpi.edu
-->

<project name="quickstart-run-tomcat" default="tomcatstart" basedir=".">
  <!-- This target normally overridden by the importing build.xml -->
  <target name="run.init">
    <property name="org.bedework.project.bedework"
              location="${basedir}/bedework" />

    <property name="org.bedework.appserver.dir"
              location="${org.bedework.project.bedework}/../apache-tomcat-5.5.17" />
  </target>

  <!-- =================================================================
       The "tomcatstart" target starts Tomcat
       ================================================================= -->

  <target name="tomcatstart-locale" depends="run.init"
          description="starts the tomcat server">
    <input message="Enter language code: "
           addproperty="tomcat.locale" />

    <input message="Enter country code: "
           addproperty="tomcat.country" />

    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Duser.language=${tomcat.locale}"/>
      <jvmarg value="-Duser.country=${tomcat.country}"/>
      <!--
      <jvmarg value="-Dfile.encoding=ISO-8859-1"/>
      -->
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart" depends="run.init"
          description="starts the tomcat server">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xms128m" />
      <jvmarg value="-Xmx630m" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <jvmarg value="-Dfile.encoding=UTF-8"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-large" depends="run.init"
          description="starts a large memory version of the tomcat server">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xms128m" />
      <jvmarg value="-Xmx1028m" />
      <jvmarg value="-XX:PermSize=128m" />
      <jvmarg value="-XX:MaxPermSize=128m" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-profile" depends="run.init"
          description="starts the tomcat server with rpofiling">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xrunyjpagent:cpu=times,onexit=cpu" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-profile-large" depends="run.init"
          description="starts the tomcat server with rpofiling">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xms128m" />
      <jvmarg value="-Xmx1028m" />
      <jvmarg value="-XX:PermSize=128m" />
      <jvmarg value="-XX:MaxPermSize=128m" />
      <jvmarg value="-server" />
      <jvmarg value="-agentlib:hprof=cpu=samples,depth=15,onexit=memory" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-profile-yk" depends="run.init"
          description="starts the tomcat server with rpofiling">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <echo message="For this to work you need to do something like:"/>
    <echo message="export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/douglm/drop2/java/yourkit/yjp-6.0.15/bin/linux-x86-32"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Xms128m" />
      <jvmarg value="-Xmx1028m" />
      <jvmarg value="-XX:PermSize=128m" />
      <jvmarg value="-XX:MaxPermSize=128m" />
      <jvmarg value="-server" />
      <jvmarg value="-agentlib:yjpagent" />
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <arg value="start"/>
    </java>
  </target>

  <target name="tomcatstart-debug" depends="run.init"
          description="starts the tomcat server with remote debugging enabled">
    <echo message="Starting Tomcat from ${org.bedework.appserver.dir}"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Djava.net.preferIPv4Stack=true"/>
      <jvmarg value="-Xdebug"/>
      <jvmarg value="-Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n"/>
      <arg value="start"/>
    </java>
  </target>

  <!-- This target is for use when sync4j is installed -->
  <target name="tomcatstart-sync4j" depends="run.init"
          description="starts the tomcat server with sync4j">
    <echo message="Starting Tomcat with sync4j"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <jvmarg value="-Dsync4j.home=${sync4j.dir}"/>
      <arg value="start"/>
    </java>
  </target>

  <!-- =================================================================
       The "tomcatstop" target stops Tomcat cleanly
       ================================================================= -->

  <target name="tomcatstop" depends="run.init">
    <echo message="Stopping Tomcat"/>
    <java fork="true" dir="${basedir}"
          classname="org.apache.catalina.startup.Bootstrap">
      <classpath>
        <pathelement path="${org.bedework.appserver.dir}/bin/bootstrap.jar"/>
      </classpath>
      <sysproperty key="catalina.home" value="${org.bedework.appserver.dir}"/>
      <!--jvmarg value="-Dcatalina.home=${tomcat.dir}"/-->
      <arg value="stop"/>
    </java>
  </target>
</project>
