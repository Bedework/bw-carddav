<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>Address Book</title>    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link href="resources/reset.css" rel="stylesheet" type="text/css"/>
    <link href="resources/addressbook.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="resources/jquery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="resources/jquery/jquery-ui-1.8.2.custom.min.js"></script>
    <script type="text/javascript" src="resources/Math.uuid.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {

        var carddavUrl = "/ucarddav";
        var userpath = "/user/";
        var bookName = "/addressbook/"; 

        // set on entry:
        $("#visitListing").attr("href",carddavUrl + userpath + $("#userid").val() + bookName);
        // change if the userid is changed:
        $("#userid").change(function() {
          $("#visitListing").attr("href",carddavUrl + userpath + $("#userid").val() + bookName);
        });

        $("#auth").click(function() {
          var addrBookUrl = carddavUrl + userpath + $("#userid").val() + bookName;
          $.ajax({
            type: "get",
            url: "",
            dataType: addrBookUrl,
            success: function(responseData){
              alert(responseData);            
            },
            error: function(msg) {
              // there was a problem
              alert(msg.statusText);
            }
          });
        });

        $("#report").click(function() {
          var addrBookUrl = carddavUrl + userpath + $("#userid").val() + bookName;
          $.ajax({
            type: "report",
            url: addrBookUrl,
            dataType: "xml",
            beforeSend: function(xhrobj) {
              xhrobj.setRequestHeader("X-HTTP-Method-Override", "REPORT");
              xhrobj.setRequestHeader("Depth", "1");
              xhrobj.setRequestHeader("Authorization", "Basic");
            },
            success: function(responseData){
              alert(responseData);            
            },
            error: function(msg) {
              // there was a problem
              alert(msg.statusText);
            }
          });
        });

        $("#add").click(function() {
          //var vcData = "BEGIN:VCARD\nFN:Venerable Bede\nUID:myveryhandcodeduid@mysite.edu6754841\nCLASS:PRIVATE\nCATEGORIES:Services\nREV:20100211T041750Z\nEMAIL;TYPE=PREF;TYPE=INTERNET:vbede@mysite.edu\nTEL;TYPE=HOME:+1 555 555-5555\nADR;TYPE=HOME:;;23 Toadstool Ln;Troy;NY;12180;\nN:Bede;Venerable;;;\nVERSION:4.0\nEND:VCARD";
          //alert($("#FN").val() + "\n" + $("#UID").val() + "\n" + $("#EMAIL").val() + "\n" + $("#HOMEPHONE").val() + "\n" + $("#ADRHOMESTREET").val());
          
          var addrBookUrl = carddavUrl + userpath + $("#userid").val() + bookName;
          var newUUID = "BwABC-" + Math.uuid();
          
          var vcData = "BEGIN:VCARD\n"
          vcData += "FN:" + $("#FIRSTNAME").val() + " " + $("#LASTNAME").val() + "\n";
          vcData += "UID:" + newUUID + "\n";
          vcData += "CLASS:PRIVATE\n";
          vcData += "REV:20100914T041750Z\n";
          vcData += "EMAIL;TYPE=PREF;TYPE=INTERNET:" + $("#EMAIL").val() + "\n";
          vcData += "TEL;TYPE=HOME:" + $("#HOMEPHONE").val() + "\n";  
          vcData += "ADR;TYPE=HOME:;;" + $("#ADRHOMESTREET").val() + ";" + $("#ADRHOMECITY").val() + ";" +  $("#ADRHOMESTATE").val() + ";" + $("#ADRHOMEPOSTAL").val() + ";\n";
          vcData += "N:" + $("#LASTNAME").val() + ";" + $("#FIRSTNAME").val() + ";;;\n"; 
          vcData += "VERSION:4.0\nEND:VCARD";
              
          $.ajax({
            type: "put",
            url: addrBookUrl + newUUID + ".vcf",
            data: vcData,
            dataType: "text",
            processData: false,
            beforeSend: function(xhrobj) {
              xhrobj.setRequestHeader("X-HTTP-Method-Override", "PUT");
              xhrobj.setRequestHeader("If-None-Match", "*");
              xhrobj.setRequestHeader("Authorization", "Basic");
              xhrobj.setRequestHeader("Content-Type", "text/vcard");
            },
            success: function(responseData){
              alert(responseData);            
            },
            error: function(msg) {
              // there was a problem
              alert(msg.statusText);
            }
          });
        });


        $("#delete").click(function() {
          var addrBookUrl = carddavUrl + userpath + $("#userid").val() + bookName;
          $.ajax({
            type: "delete",
            url: addrBookUrl + $("#DUID").val() + ".vcf",
            dataType: "text",
            beforeSend: function(xhrobj) {
              xhrobj.setRequestHeader("X-HTTP-Method-Override", "DELETE");
              xhrobj.setRequestHeader("Authorization", "Basic");
            },
            success: function(responseData){
              alert(responseData);            
            },
            error: function(msg) {
              // there was a problem
              alert(msg.statusText);
            }
          });
        });       
        
      });
    </script>
  </head>
  <body>
    <div id="header">
      <h1>Bedework Address Book</h1>
      <p>Test page for user <input type="text" id="userid" size="20" value="vbede"/> <a href="#" id="visitListing" target="_blank">Visit Listing</a></p>
      <p>
        <button id="auth" type="button">Authenticate/Test</button>
        <button id="report" type="button">Report</button>
      </p>
      <hr/>
      <h3>Add Contact</h3>
      <div id="addForm">
        First Name: <input type="text" size="60" value="" id="FIRSTNAME"/><br/>
        Last Name: <input type="text" size="60" value="" id="LASTNAME"/><br/>
        Email: <input type="text" size="60" value="" id="EMAIL"/><br/>
        Home Phone: <input type="text" size="60" value="" id="HOMEPHONE"/><br/>
        Home Address Street: <input type="text" size="60" value="" id="ADRHOMESTREET"/><br/>
        Home Address City: <input type="text" size="60" value="" id="ADRHOMECITY"/><br/>
        Home Address State: <input type="text" size="60" value="" id="ADRHOMESTATE"/><br/>
        Home Address Postal Code: <input type="text" size="60" value="" id="ADRHOMEPOSTAL"/><br/>
        <button id="add" type="button">Add Contact</button>
      </div>
      <hr/>
      <h3>Delete Contact (by UID)</h3>
      <div id="deleteForm">
        UID: <input type="text" size="60" value="" id="DUID"/><br/>
        <button id="delete" type="button">Delete Contact</button>
      </div>
    </div>
  </body>
</html>